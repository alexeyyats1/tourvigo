<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Чатбот Ита - Подбор программ</title>
<link href="https://fonts.googleapis.com/css2?family=Gilroy:wght@300;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}@font-face{font-family:Gilroy;src:local('Gilroy Light'),local('Gilroy-Light');font-weight:300}@font-face{font-family:Gilroy;src:local('Gilroy Medium'),local('Gilroy-Medium');font-weight:500}body{font-family:Gilroy,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background-color:#f8f8f8;position:relative;height:100vh;overflow:hidden}.main-layout{display:flex;height:100vh;overflow:hidden}.history-sidebar{width:570px;padding-left:58px;padding-right:40px;padding-top:160px;position:relative}.history-header{margin-bottom:40px}.history-subtitle{font-size:20px;font-weight:300;color:#353535;margin-bottom:12px}.history-title{font-size:58px;font-weight:500;color:#000;line-height:1.2;margin-bottom:8px;width:130%}.history-list-wrapper{position:relative;margin-top:40px}.history-list{position:relative;max-height:calc(5 * 80px);overflow-y:auto;padding-right:10px;z-index:10}.history-list::-webkit-scrollbar{width:6px}.history-list::-webkit-scrollbar-track{background:0 0}.history-list::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2);border-radius:3px}.history-list::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.3)}.history-gradient{position:absolute;bottom:0;left:0;right:0;height:80px;background:linear-gradient(to bottom,transparent,#f8f8f8);pointer-events:none;opacity:0;transition:opacity .3s}.history-gradient.visible{opacity:1}.history-item{background:#fff;border-radius:12px;padding:16px 20px;margin-bottom:12px;cursor:pointer;transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,.05);display:flex;align-items:center;justify-content:space-between;min-height:68px}.history-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.1);transform:translateY(-2px)}.history-item-content{flex:1}.history-item-dates{font-size:16px;color:#666;margin-bottom:4px}.history-item-destination{font-size:18px;color:#000;font-weight:500;display:flex;align-items:center;gap:8px}.history-item-destination input{font-size:18px;color:#000;font-weight:500;border:1px solid#2954ff;border-radius:6px;padding:4px 8px;background:#fff;font-family:Gilroy,sans-serif;outline:0}.edit-icon,.delete-icon{width:16px;height:16px;cursor:pointer;opacity:.6;transition:opacity .3s;flex-shrink:0}.edit-icon:hover,.delete-icon:hover{opacity:1}.history-item-icons{display:flex;gap:8px;align-items:center}.history-item-type{font-size:16px;color:#666;margin-top:2px}.history-item-arrow{color:#2954ff;font-size:22px}.chatbot-container{flex:1;display:flex;justify-content:flex-end;align-items:flex-start;padding-top:120px;padding-right:58px}.chatbot-wrapper{width:100%;max-width:42rem;background:#fff;border-radius:25px;box-shadow:0 10px 40px rgba(0,0,0,.1);overflow:hidden;display:flex;flex-direction:column;height:80vh}.progress-bar-container{height:12px;padding:6px 15px;position:relative}.progress-bar{position:absolute;left:15px;height:4px;background:#2954ff;border-radius:2px;transition:all .3s}.messages-area{flex:1;overflow-y:auto;padding:12px 16px}.message-wrapper{display:flex;gap:10px;margin-bottom:12px}.message-wrapper.user{flex-direction:row-reverse}.message-avatar{width:45px;height:45px;border-radius:50%;object-fit:cover;flex-shrink:0}.message-content{display:flex;flex-direction:column;gap:4px;max-width:75%}.message-wrapper.user .message-content{align-items:flex-end}.message-sender{font-size:19px;color:#666}.message-bubble{padding:8px 12px;border-radius:16px;white-space:pre-line;font-size:19px;color:#353535;line-height:1.4}.message-wrapper.user .message-bubble{background:#e9ecff;border-bottom-right-radius:4px;text-align:right}.message-wrapper.bot .message-bubble{background:#f8f8f8;border-bottom-left-radius:4px;text-align:left}.message-hint{font-size:19px;color:#6b7280;font-style:italic;margin-top:4px}.loading-dots{display:flex;gap:4px}.loading-dot{width:8px;height:8px;background:#9ca3af;border-radius:50%;animation:bounce 1.4s infinite ease-in-out both}.loading-dot:nth-child(1){animation-delay:-.32s}.loading-dot:nth-child(2){animation-delay:-.16s}@keyframes bounce{0%,100%,80%{transform:scale(0)}40%{transform:scale(1)}}.partner-links-container{display:flex;flex-direction:column;gap:8px;margin:12px 0;padding:0 16px}.partner-link-button{display:inline-flex;align-items:center;justify-content:space-between;gap:12px;background:#2954ff;color:#fff;padding:12px 16px;border-radius:12px;text-decoration:none;font-size:16px;transition:all .3s}.partner-link-button:hover{background:#1a43e0;transform:translateY(-2px)}.partner-link-text{flex:1}.partner-link-icon{width:18px;height:18px}.quick-replies{padding:0 16px 8px;display:flex;flex-wrap:wrap;gap:6px;justify-content:flex-end}.quick-reply-btn{background:#e9ecff;color:#2954ff;border:none;border-radius:16px;padding:8px 14px;font-size:18px;font-weight:500;cursor:pointer;transition:all .3s}.quick-reply-btn:hover{background:#d8dcff}.input-area{padding:0 16px 16px}.input-container{display:flex;gap:6px;padding:8px;background:#f8f8f8;border-radius:16px;border:1px solid #e5e5e5}.text-input{flex:1;background:0 0;border:none;outline:0;font-size:19px;color:#000}.text-input::placeholder{color:#161616;opacity:.4}.continue-btn,.send-btn{background:#2954ff;color:#fff;border:none;border-radius:16px;padding:8px 14px;font-size:16px;font-weight:500;font-family:Gilroy,sans-serif;cursor:pointer;transition:all .3s}.continue-btn:hover,.send-btn:hover{background:#1a43e0}.back-btn{width:100%;padding:8px 14px;font-size:19px;border:1px solid #ddd;background:#f8f8f8;color:#666;border-radius:16px;cursor:pointer;transition:all .3s;margin-bottom:8px}.back-btn:hover{background:#e9e9e9}.option-btn{width:100%;display:flex;align-items:center;gap:12px;padding:10px 14px;background:#f5f5f7;border:none;border-radius:12px;cursor:pointer;transition:all .3s;text-align:left;margin-bottom:6px}.option-btn:hover{background:#e9ecff}.option-text{font-size:19px;color:#353535}.counter-row{display:flex;align-items:center;justify-content:space-between;padding:10px;background:#fff;border-radius:8px;border:1px solid #ddd;margin-bottom:10px}.counter-label{font-size:19px;color:#333}.counter-controls{display:flex;align-items:center;gap:10px}.counter-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid #2954ff;color:#333;border-radius:50%;cursor:pointer;transition:all .3s;font-size:19px}.counter-btn:hover{background:#f5f5f5}.counter-value{min-width:30px;text-align:center;color:#333;font-size:19px}.children-list{margin-top:10px}.child-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#f5f5f7;border-radius:8px;margin-bottom:6px}.child-age-label{font-size:17px;color:#333}.remove-child-btn{background:#f44;color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:14px;cursor:pointer;transition:all .3s}.remove-child-btn:hover{background:#c00}.add-child-btn{width:100%;padding:10px;background:#e9ecff;color:#2954ff;border:1px solid #2954ff;border-radius:8px;cursor:pointer;transition:all .3s;font-size:17px;margin-top:0;margin-bottom:10px}.add-child-btn:hover{background:#d8dcff}.age-selector{margin-top:10px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:8px}.age-selector-label{font-size:16px;color:#666;margin-bottom:8px}.age-options{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}.age-option-btn{padding:8px;background:#f5f5f7;border:1px solid #ddd;border-radius:6px;cursor:pointer;transition:all .3s;font-size:15px}.age-option-btn:hover{background:#e9ecff;border-color:#2954ff}.date-inputs{display:flex;gap:10px;margin-bottom:8px}.date-input-wrapper{flex:1;position:relative}.date-btn{width:100%;display:flex;align-items:center;justify-content:flex-start;gap:8px;padding:10px 12px;font-size:19px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer;transition:all .3s}.date-btn:hover{background:#f5f5f5}.calendar{position:absolute;z-index:50;margin-top:4px;padding:16px;background:#1c1c1e;color:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.3);bottom:100%;margin-bottom:8px}.calendar-header{display:flex;justify-content:center;align-items:center;margin-bottom:12px;position:relative}.calendar-nav-btn{position:absolute;width:32px;height:32px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.7);background:0 0;border:none;border-radius:8px;cursor:pointer;transition:all .3s;font-size:19px}.calendar-nav-btn:hover{color:#fff;background:rgba(255,255,255,.1)}.calendar-nav-btn.prev{left:4px}.calendar-nav-btn.next{right:4px}.calendar-title{font-size:19px;color:#fff}.calendar-days-header{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px}.calendar-day-label{font-size:19px;color:#8e8e93;text-align:center;height:40px;display:flex;align-items:center;justify-content:center}.calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}.calendar-day{width:40px;height:40px;font-size:19px;border-radius:50%;background:0 0;border:none;color:#8e8e93;cursor:pointer;transition:all .3s;position:relative;z-index:2}.calendar-day:hover:not(.disabled){background:rgba(255,255,255,.1);color:#fff}.calendar-day.selected{background:#0a84ff;color:#fff}.calendar-day.today{background:#636366;color:#fff}.calendar-day.empty{cursor:default}.calendar-day.disabled{opacity:.3;cursor:not-allowed;color:#555}.calendar-day.disabled:hover{background:0 0;color:#555}.calendar-day.in-range{background:rgba(54,102,255,.2);border-radius:0}.calendar-day.in-range:first-child{border-top-left-radius:50%;border-bottom-left-radius:50%}.calendar-day.in-range:last-child{border-top-right-radius:50%;border-bottom-right-radius:50%}.checkbox-list{margin-bottom:8px}.checkbox-label{display:flex;align-items:center;gap:8px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:8px;cursor:pointer;transition:all .3s;margin-bottom:6px}.checkbox-label:hover{background:#f5f5f5}.checkbox-input{width:20px;height:20px;border-radius:4px;border:2px solid #ddd;background:#fff;cursor:pointer;flex-shrink:0;position:relative;transition:all .3s;appearance:none;-webkit-appearance:none}.checkbox-input:checked{background:#2954ff;border-color:#2954ff}.checkbox-input:checked::after{content:'✓';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:14px;font-weight:700}.checkbox-text{font-size:19px;color:#333;flex:1}.button-row{display:flex;gap:8px}.button-row .back-btn,.button-row .continue-btn{flex:1;margin-bottom:0}.footer{position:fixed;bottom:0;left:0;right:0;padding:28px;display:flex;justify-content:center;align-items:center;background:0 0;pointer-events:none;z-index:5}.email-input-container{margin:12px 0;padding:0 16px}.email-input-wrapper{display:flex;gap:6px;padding:8px;background:#f8f8f8;border-radius:16px;border:1px solid #e5e5e5}.email-input{flex:1;background:0 0;border:none;outline:0;font-size:19px;color:#000;font-family:Gilroy,sans-serif}.email-input::placeholder{color:#161616;opacity:.4}.email-send-btn{background:#2954ff;color:#fff;border:none;border-radius:16px;padding:8px 14px;font-size:16px;font-weight:500;font-family:Gilroy,sans-serif;cursor:pointer;transition:all .3s}.email-send-btn:hover{background:#1a43e0}.email-send-btn:disabled{background:#9ca3af;cursor:not-allowed}.additional-preferences-container{margin:12px 0;padding:0 16px}.additional-preferences-wrapper{display:flex;gap:6px;padding:8px;background:#f8f8f8;border-radius:16px;border:1px solid #e5e5e5}.additional-preferences-input{flex:1;background:0 0;border:none;outline:0;font-size:19px;color:#000;font-family:Gilroy,sans-serif}.additional-preferences-input::placeholder{color:#161616;opacity:.4}.additional-preferences-send-btn{background:#2954ff;color:#fff;border:none;border-radius:16px;padding:8px 14px;font-size:16px;font-weight:500;font-family:Gilroy,sans-serif;cursor:pointer;transition:all .3s}.additional-preferences-send-btn:hover{background:#1a43e0}.additional-preferences-send-btn:disabled{background:#9ca3af;cursor:not-allowed}@media (max-width:1200px){.history-sidebar{display:none}.chatbot-container{padding:20px;padding-top:80px}.chatbot-wrapper{max-width:100%;height:calc(100vh - 160px)}}
</style>
</head>
<body>
<div class="main-layout">
<div class="history-sidebar">
<div class="history-header">
<div class="history-subtitle">История запросов</div>
<h1 class="history-title">Здесь мы сохраним все полезные ссылки</h1>
</div>
<div class="history-list-wrapper">
<div class="history-list" id="historyList"></div>
<div class="history-gradient" id="historyGradient"></div>
</div>
</div>
<div class="chatbot-container">
<div class="chatbot-wrapper">
<div class="progress-bar-container">
<div class="progress-bar" id="progressBar" style="width:0"></div>
</div>
<div class="messages-area" id="messagesArea"></div>
<div class="quick-replies" id="quickReplies"></div>
<div class="input-area" id="inputArea"></div>
</div>
</div>
</div>
<div class="footer"></div>
<script>
emailjs.init("GhvXaAuEJgPTGDgLr");
const MONTHS_RU=['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
const DAYS_SHORT=['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
const urlParams=new URLSearchParams(window.location.search);
const isAlternativeScenario=urlParams.has('non');
function isDateInColdSeason(dateFrom,dateTo){if(!dateFrom||!dateTo)return false;const fromDate=new Date(dateFrom);const toDate=new Date(dateTo);const isColdSeason1=(fromDate.getMonth()>=8||fromDate.getMonth()<=4)||(toDate.getMonth()>=8||toDate.getMonth()<=4);const isColdSeason2=(fromDate.getMonth()>=9&&fromDate.getDate()>=15)||(toDate.getMonth()<=4&&toDate.getDate()<=1)||(fromDate.getMonth()>=10||fromDate.getMonth()<=3);return isColdSeason1||isColdSeason2;}
function isDateForTrekking(dateFrom,dateTo){if(!dateFrom||!dateTo)return true;const fromDate=new Date(dateFrom);const toDate=new Date(dateTo);const fromMonth=fromDate.getMonth();const toMonth=toDate.getMonth();return!((fromMonth>=8&&fromDate.getDate()>=15)||(toMonth<=5&&toDate.getDate()<=15)||(fromMonth>=9||fromMonth<=5));}
function isDateForWinterSports(dateFrom,dateTo){if(!dateFrom||!dateTo)return false;const fromDate=new Date(dateFrom);const toDate=new Date(dateTo);const fromMonth=fromDate.getMonth();const toMonth=toDate.getMonth();return(fromMonth===11||toMonth===0||(fromMonth===11&&fromDate.getDate()>=1)||(toMonth===1&&toDate.getDate()<=1));}
function isDateInColdSeasonForBeach(dateFrom,dateTo){if(!dateFrom||!dateTo)return false;const fromDate=new Date(dateFrom);const toDate=new Date(dateTo);const october1=new Date(fromDate.getFullYear(),9,1);const june1NextYear=new Date(fromDate.getFullYear()+1,5,1);const tripStartsInColdSeason=(fromDate>=october1&&fromDate<=june1NextYear)||(toDate>=october1&&toDate<=june1NextYear)||(fromDate<=october1&&toDate>=june1NextYear);return tripStartsInColdSeason;}
function hasAllergyAndLocalCuisine(answers){const healthRestrictions=answers[22];const travelPurpose=answers[7];return healthRestrictions==="Аллергия"&&travelPurpose==="Местная кухня";}
function hasBeachWithHealthIssues(answers){const travelPurpose=answers[7];const healthRestrictions=answers[22];const weatherPreference=answers[20];if(travelPurpose!=="Пляж и море")return false;const relevantHealthIssues=["Сердечно-сосудистые","Заболевания кожи"];return relevantHealthIssues.includes(healthRestrictions)&&weatherPreference==="Жарко";}
function hasActiveTourWithHealthIssues(answers){const travelPurpose=answers[7];const healthRestrictions=answers[22];const activeTours=["Треккинг","Треккинг и сплавы","Сноуборд/лыжи"];return activeTours.includes(travelPurpose)&&healthRestrictions==="Опорно-двигательные";}
const questionsAlternative=[{text:"Из какого города планируешь выезд?",type:"text"},{text:"Куда хочешь поехать?",type:"text"},{text:"С кем ты планируешь путешествие?",type:"single",options:[{text:"Один/одна",value:"Один/одна"},{text:"Пара (вдвоем)",value:"Пара (вдвоем)"},{text:"Семья с детьми",value:"Семья с детьми"},{text:"Компания друзей",value:"Компания друзей"}]},{text:"Сколько взрослых и детей будет в поездке?",type:"counter_with_ages",showIf:(answers)=>answers[2]==="Семья с детьми"},{text:"Сколько человек будет в поездке?",type:"counter",showIf:(answers)=>answers[2]==="Компания друзей"},{text:"Выбери даты поездки",type:"date"},{text:"Какой тип бюджета ты придерживаешься?",type:"single",options:[{text:"Эконом",value:"Эконом"},{text:"Комфорт",value:"Комфорт"},{text:"Премиум",value:"Премиум"},{text:"Люкс",value:"Люкс"}]},{text:"Какой бюджет на одного человека?",type:"single",options:[{text:"До 50 тысяч рублей",value:"До 50к"},{text:"50-100 тысяч рублей",value:"50-100к"},{text:"100-300 тысяч рублей",value:"100-300к"},{text:"300-500 тысяч рублей",value:"300-500к"},{text:"Более 500 тысяч рублей",value:"Более 500к"}]}];
const questionsStandard=[{text:"Из какого города планируешь выезд?",type:"text"},{text:"С кем ты планируешь путешествие?",type:"single",options:[{text:"Один/одна",value:"Один/одна"},{text:"Пара (вдвоем)",value:"Пара (вдвоем)"},{text:"Семья с детьми",value:"Семья с детьми"},{text:"Компания друзей",value:"Компания друзей"}]},{text:"Сколько взрослых и детей будет в поездке?",type:"counter_with_ages",showIf:(answers)=>answers[1]==="Семья с детьми"},{text:"Сколько человек будет в поездке?",type:"counter",showIf:(answers)=>answers[1]==="Компания друзей"},{text:"Выбери даты поездки",type:"date"},{text:"Какой тип бюджета ты придерживаешься?",type:"single",options:[{text:"Эконом",value:"Эконом"},{text:"Комфорт",value:"Комфорт"},{text:"Премиум",value:"Премиум"},{text:"Люкс",value:"Люкс"}]},{text:"Какой бюджет на одного человека?",type:"single",options:[{text:"До 50 тысяч рублей",value:"До 50к"},{text:"50-100 тысяч рублей",value:"50-100к"},{text:"100-300 тысяч рублей",value:"100-300к"},{text:"300-500 тысяч рублей",value:"300-500к"},{text:"Более 500 тысяч рублей",value:"Более 500к"}]},{text:"Если бы пришлось выбрать только одно, ради чего ты едешь в путешествие?",type:"single",options:(answers)=>{const dateInfo=answers[4];const isWinterSportsSeason=isDateForWinterSports(dateInfo?.from,dateInfo?.to);const isTrekkingSeason=isDateForTrekking(dateInfo?.from,dateInfo?.to);const baseOptions=[{text:"Пляж и море",value:"Пляж и море"},{text:"Горы и природа",value:"Горы и природа"},{text:"Культура и история",value:"Культура и история"},{text:"Местная кухня",value:"Местная кухня"},{text:"Шоппинг",value:"Шоппинг"},{text:"SPA и оздоровление",value:"SPA и оздоровление"}];if(isTrekkingSeason){if(answers[1]!=="Семья с детьми"){baseOptions.push({text:"Треккинг",value:"Треккинг"});}}else{if(answers[1]!=="Семья с детьми"){baseOptions.push({text:"Треккинг и сплавы",value:"Треккинг и сплавы"});}}
if(isWinterSportsSeason){baseOptions.push({text:"Сноуборд/лыжи",value:"Сноуборд/лыжи"});}
return baseOptions;}},{text:"Какой уровень сложности тебе подходит?",type:"single",showIf:(answers)=>answers[7]==="Треккинг и сплавы",options:[{text:"Новичок (легкие маршруты)",value:"Новичок"},{text:"Средний (требует некоторой подготовки)",value:"Средний"},{text:"Профи (сложные маршруты с нагрузкой)",value:"Профи"}]},{text:"Хотел(а) бы ты также экскурсии во время пляжного отдыха?",type:"single",showIf:(answers)=>answers[7]==="Пляж и море",options:[{text:"Да, хотелось бы много экскурсий",value:"Много экскурсий"},{text:"Да, но немного экскурсий",value:"Немного экскурсий"},{text:"Можно не больше двух экскурсий",value:"Не больше двух"},{text:"Совсем не хочу экскурсий",value:"Совсем не хочу"}]},{text:"Какой пляжный отдых тебе нравится?",type:"single",showIf:(answers)=>answers[7]==="Пляж и море",options:(answers)=>{if(answers[1]==="Семья с детьми"){return[{text:"Тихие бухты и дикие пляжи",value:"Тихие бухты"},{text:"Пляжи с детской инфраструктурой",value:"Пляжи с детской инфраструктурой"},{text:"Отели с детскими клубами",value:"Отели с детскими клубами"}];}else if(answers[1]==="Компания друзей"){return[{text:"Тихие бухты и дикие пляжи",value:"Тихие бухты"},{text:"Пляжи с вечеринками",value:"Пляжи с вечеринками"},{text:"Молодежные курорты",value:"Молодежные курорты"}];}else{return[{text:"Тихие бухты и дикие пляжи",value:"Тихие бухты"},{text:"Пляжи с ресторанами и шезлонгами",value:"Пляжи с ресторанами"},{text:"Пляжи для спорта и активностей",value:"Пляжи для спорта"}];}}},{text:"Что еще важно для тебя кроме культуры и истории? (можно выбрать несколько)",type:"multi",showIf:(answers)=>answers[7]==="Культура и история",options:[{text:"Природа и парки",value:"Природа и парки"},{text:"Пляжный отдых",value:"Пляжный отдых"},{text:"Местная кухня и рестораны",value:"Местная кухня"},{text:"Шоппинг",value:"Шоппинг"},{text:"SPA и оздоровление",value:"SPA"},{text:"Активный отдых (треккинг, сплавы)",value:"Активный отдых"},{text:"Ночная жизнь и развлечения",value:"Ночная жизнь"},{text:"Ничего не нужно, только культура и история",value:"Только культура"}]},{text:"Какой уровень сложности активных маршрутов тебе подходит?",type:"single",showIf:(answers)=>{return answers[7]==="Культура и история"&&Array.isArray(answers[11])&&answers[11].includes("Активный отдых");},options:[{text:"Новичок (легкие маршруты)",value:"Новичок"},{text:"Средний (требует некоторой подготовки)",value:"Средний"},{text:"Профи (сложные маршруты с нагрузкой)",value:"Профи"}]},{text:"Что тебя интересует в культуре и истории? (можно выбрать несколько)",type:"multi",showIf:(answers)=>answers[7]==="Культура и история",options:[{text:"Исторические памятники и архитектура",value:"Памятники"},{text:"Музеи и галереи",value:"Музеи"},{text:"Зоопарки и океанариумы",value:"Зоопарки"},{text:"Интерактивные музеи",value:"Интерактивные музеи"},{text:"Экскурсии по старым городам",value:"Экскурсии"},{text:"Религиозные сооружения",value:"Религиозные сооружения"}]},{text:"Какие исторические эпохи тебе интересны? (можно выбрать несколько)",type:"multi",showIf:(answers)=>{return answers[7]==="Культура и история"&&Array.isArray(answers[13])&&answers[13].includes("Памятники");},options:[{text:"Античность (Древняя Греция, Рим)",value:"Античность"},{text:"Средневековье (рыцари, замки)",value:"Средневековье"},{text:"Эпоха Возрождения",value:"Возрождение"},{text:"Новое время (18-19 века)",value:"Новое время"},{text:"Современность (20-21 века)",value:"Современность"},{text:"Не важно",value:"Не важно"}]},{text:"Какие музеи тебе интересны? (можно выбрать несколько)",type:"multi",showIf:(answers)=>{return answers[7]==="Культура и история"&&Array.isArray(answers[13])&&answers[13].includes("Музеи");},options:[{text:"Художественные музеи",value:"Художественные"},{text:"Исторические музеи",value:"Исторические"},{text:"Научно-технические музеи",value:"Научные"},{text:"Этнографические музеи",value:"Этнографические"},{text:"Археологические музеи",value:"Археологические"},{text:"Любые музеи",value:"Любые"}]},{text:"Какая именно кухня тебе интересна? (можно выбрать несколько)",type:"multi",showIf:(answers)=>answers[7]==="Местная кухня",hint:"Фьюжн-кухня - смешение кулинарных традиций",options:[{text:"Уличная еда",value:"Уличная еда"},{text:"Дорогие рестораны",value:"Дорогие рестораны"},{text:"Национальная кухня",value:"Национальная"},{text:"Фьюжн-кухня",value:"Фьюжн-кухня"},{text:"Вегетарианская/веганская",value:"Вегетарианская"},{text:"Морепродукты",value:"Морепродукты"},{text:"Любая кухня",value:"Любая"}]},{text:"Какой именно шоппинг тебя интересует? (можно выбрать несколько)",type:"multi",showIf:(answers)=>answers[7]==="Шоппинг",options:[{text:"Модная одежда и обувь",value:"Одежда"},{text:"Ювелирные изделия и украшения",value:"Ювелирные"},{text:"Электроника и гаджеты",value:"Электроника"},{text:"Косметика и парфюмерия",value:"Косметика"},{text:"Сувениры и местные изделия",value:"Сувениры"},{text:"Антиквариат и винтаж",value:"Антиквариат"},{text:"Роскошные бренды",value:"Роскошные бренды"},{text:"Аутлеты и распродажи",value:"Аутлеты"},{text:"Местные рынки и базары",value:"Местные рынки"}]},{text:"Что тебя привлекает в горах и природе?",type:"single",showIf:(answers)=>answers[7]==="Горы и природа",options:(answers)=>{if(answers[1]==="Семья с детьми"){return[{text:"Красивые виды для фото",value:"Виды"},{text:"Прогулки по лесу",value:"Лес"},{text:"Наблюдение за животными",value:"Животные"},{text:"Прогулки по национальным паркам",value:"Парки"}];}else if(answers[1]==="Компания друзей"){return[{text:"Походы с палатками",value:"Походы с палатками"},{text:"Активные маршруты",value:"Активные маршруты"},{text:"Приключенческие туры",value:"Приключенческие туры"},{text:"Кемпинги",value:"Кемпинги"}];}else{return[{text:"Горные походы и треккинг",value:"Треккинг"},{text:"Красивые виды для фото",value:"Виды"},{text:"Наблюдение за животными",value:"Животные"},{text:"Отдых в лесу",value:"Лес"}];}}},{text:"Ты готов/готова к спартанским условиям и долгим переездам по бездорожью ради уникальных видов?",type:"single",showIf:(answers)=>answers[7]==="Горы и природа"&&answers[1]!=="Семья с детьми",options:[{text:"Да, готов/готова к приключениям",value:"Готов к приключениям"},{text:"Нужен комфорт и хорошие условия",value:"Нужен комфорт"}]},{text:"Какая погода тебе нравится?",type:"single",showIf:(answers)=>{if(answers[7]==="Сноуборд/лыжи")return false;if(answers[7]==="Треккинг")return false;return answers[7]!=="Горы и природа";},options:[{text:"Люблю когда жарко",value:"Жарко"},{text:"Тепло, но не жарко",value:"Тепло"},{text:"Прохладно и свежо",value:"Прохладно"},{text:"Любая погода",value:"Любая"}]},{text:"Есть ли ограничения по транспорту?",type:"single",options:[{text:"Нет ограничений",value:"Нет"},{text:"Не летаю на самолетах",value:"Не летаю"},{text:"Не езжу на поездах",value:"Не езжу на поездах"},{text:"Не езжу на автобусах",value:"Не езжу на автобусах"}]},{text:"Есть ли ограничения по здоровью?",type:"single",options:[{text:"Нет ограничений",value:"Нет"},{text:"Сердечно-сосудистые заболевания",value:"Сердечно-сосудистые"},{text:"Заболевания кожи",value:"Кожные"},{text:"Заболевания опорно-двигательного аппарата",value:"Опорно-двигательные"},{text:"Аллергия на часть продуктов",value:"Аллергия"}]},{text:"Куда хочешь поехать?",type:"single",options:(answers)=>{const dateInfo=answers[4];const travelPurpose=answers[7];const weatherPreference=answers[20];const baseOptions=[{text:"Россия",value:"Россия"},{text:"Ближнее зарубежье",value:"Ближнее зарубежье"},{text:"Европа",value:"Европа"},{text:"Азия",value:"Азия"},{text:"Не важно, куда угодно",value:"Не важно"}];if(travelPurpose==="Пляж и море"&&dateInfo&&dateInfo.from&&dateInfo.to){const isColdSeasonForBeach=isDateInColdSeasonForBeach(dateInfo.from,dateInfo.to);if(isColdSeasonForBeach){return baseOptions.filter(option=>option.value!=="Россия");}}
if(weatherPreference==="Жарко"&&isDateInColdSeason(dateInfo?.from,dateInfo?.to)){return baseOptions.filter(option=>option.value!=="Россия");}
if(weatherPreference==="Тепло"&&isDateInColdSeason(dateInfo?.from,dateInfo?.to)){return baseOptions.filter(option=>option.value!=="Россия");}
return baseOptions;}},{text:"Есть ли у тебя дополнительные пожелания к программе? (необязательно)",type:"additional_preferences"}];
const questions=isAlternativeScenario?questionsAlternative:questionsStandard;
let state={currentQuestionIndex:0,answers:{},shownQuestions:[],isSurveyStarted:false,isBriefCompleted:false,adultsCount:1,childrenCount:0,childrenAges:[],selectedMultiple:[],dateFrom:null,dateTo:null,showDateFromPicker:false,showDateToPicker:false,currentProposals:[],selectedProposal:null,isLoading:false,currentCalendarMonth:new Date(),currentChatId:null,isViewingHistory:false,isAlternativeScenario:isAlternativeScenario,tourProgram:'',partnerLinks:[],showAgeSelector:false,excursionDays:3,hasHealthWarning:false,healthWarningType:null,chatMessages:[]};
const messagesArea=document.getElementById('messagesArea');const quickReplies=document.getElementById('quickReplies');const inputArea=document.getElementById('inputArea');const progressBar=document.getElementById('progressBar');const historyList=document.getElementById('historyList');const historyGradient=document.getElementById('historyGradient');
function transliterate(text){const map={'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'e','ж':'zh','з':'z','и':'i','й':'y','к':'k','л':'l','м':'m','н':'n','о':'o','п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f','х':'h','ц':'ts','ч':'ch','ш':'sh','щ':'sch','ъ':'','ы':'y','ь':'','э':'e','ю':'yu','я':'ya','А':'A','Б':'B','В':'V','Г':'G','Д':'D','Е':'E','Ё':'E','Ж':'Zh','З':'Z','И':'I','Й':'Y','К':'K','Л':'L','М':'M','Н':'N','О':'O','П':'P','Р':'R','С':'S','Т':'T','У':'U','Ф':'F','Х':'H','Ц':'Ts','Ч':'Ch','Ш':'Sh','Щ':'Sch','Ъ':'','Ы':'Y','Ь':'','Э':'E','Ю':'Yu','Я':'Ya',' ':'-','-':'-'};return text.split('').map(char=>map[char]||char).join('');}
function capitalizeFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1);}
function findAirportCode(cityName){if(!window.AIRPORT_DATABASE){console.error('AIRPORT_DATABASE не загружена!');return null;}
const cityLower=cityName.toLowerCase().trim();for(const[key,value]of Object.entries(window.AIRPORT_DATABASE)){if(key.toLowerCase()===cityLower){console.log(`✅ Точное совпадение для ${cityName}:`,value);return value;}}
for(const[key,value]of Object.entries(window.AIRPORT_DATABASE)){if(cityLower.includes(key.toLowerCase())||key.toLowerCase().includes(cityLower)){console.log(`⚠️ Частичное совпадение для ${cityName} с ${key}:`,value);return value;}}
console.warn(`❌ Аэропорт не найден для города: ${cityName}`);return null;}
function getNearestMajorCity(fromCity){const fromCityLower=fromCity.toLowerCase();const spbRegion=['санкт-петербург','петербург','спб','архангельск','мурманск','петрозаводск','вологда','псков','новгород','череповец'];for(let city of spbRegion){if(fromCityLower.includes(city)||city.includes(fromCityLower)){return{code:'LED',name:'Санкт-Петербург',translit:'saint-petersburg'};}}
return{code:'MOW',name:'Москва',translit:'moscow'};}
function init(){loadChatHistory();renderHistoryList();if(isAlternativeScenario){addMessage("Привет! Я Ита, твой AI-друг в мире путешествий. Я помогу подобрать лучшие варианты для твоей поездки. Начнем?",false);}else{addMessage("Привет! Я Ита, твой AI-друг в мире путешествий. Могу подобрать идеальную программу по твоим предпочтениям. Начнем?",false);}
renderQuickReplies();}
function updateProgress(){if(!state.isSurveyStarted){progressBar.style.width='0';return;}
let totalToShow=0;for(let i=0;i<questions.length;i++){const question=questions[i];if(!question.showIf||question.showIf(state.answers)){totalToShow++;}}
const currentProgress=state.shownQuestions.length;const percentage=Math.min(100,(currentProgress/totalToShow)*100);progressBar.style.width=`calc(${percentage}% - 30px)`;}
function getChatHistory(){const historyJson=localStorage.getItem('chatHistory');return historyJson?JSON.parse(historyJson):[];}
function loadChatHistory(){}
function saveChatToHistory(destination,dateFrom,dateTo,partnerLinks){const history=getChatHistory();const newChat={id:Date.now(),destination:destination,name:destination,dateFrom:dateFrom,dateTo:dateTo,links:partnerLinks,createdAt:new Date().toISOString(),messages:[...state.chatMessages],state:{...state}};history.unshift(newChat);if(history.length>20){history.splice(20);}
localStorage.setItem('chatHistory',JSON.stringify(history));renderHistoryList();console.log('✅ Программа сохранена в историю:',newChat);}
function updateChatName(chatId,newName){const history=getChatHistory();const chat=history.find(c=>c.id===chatId);if(chat){chat.name=newName;chat.destination=newName;localStorage.setItem('chatHistory',JSON.stringify(history));renderHistoryList();}}
function deleteChat(chatId){const history=getChatHistory();const filteredHistory=history.filter(c=>c.id!==chatId);localStorage.setItem('chatHistory',JSON.stringify(filteredHistory));renderHistoryList();}
function renderHistoryList(){const history=getChatHistory();historyList.innerHTML='';if(history.length===0)return;history.forEach((chat,index)=>{const item=document.createElement('div');item.className='history-item';const dateFrom=new Date(chat.dateFrom);const dateTo=new Date(chat.dateTo);const dateFromStr=`${dateFrom.getDate()} ${MONTHS_RU[dateFrom.getMonth()].toLowerCase()}`;const dateToStr=`${dateTo.getDate()} ${MONTHS_RU[dateTo.getMonth()].toLowerCase()} ${dateTo.getFullYear()}`;const displayName=chat.name||chat.destination;item.innerHTML=`<div class="history-item-content"><div class="history-item-dates">${dateFromStr} — ${dateToStr}</div><div class="history-item-destination"><span class="destination-text">${displayName}</span><div class="history-item-icons"><svg class="edit-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2954ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg><svg class="delete-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ff4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></div></div></div><div class="history-item-arrow">→</div>`;const editIcon=item.querySelector('.edit-icon');const deleteIcon=item.querySelector('.delete-icon');const destinationText=item.querySelector('.destination-text');editIcon.onclick=(e)=>{e.stopPropagation();const input=document.createElement('input');input.type='text';input.value=displayName;input.onclick=(e)=>e.stopPropagation();input.onblur=()=>{const newName=input.value.trim()||displayName;updateChatName(chat.id,newName);};input.onkeypress=(e)=>{if(e.key==='Enter'){input.blur();}};destinationText.replaceWith(input);input.focus();input.select();};deleteIcon.onclick=(e)=>{e.stopPropagation();if(confirm('Удалить этот чат из истории?')){deleteChat(chat.id);}};item.onclick=()=>openHistoryChat(chat);historyList.appendChild(item);});if(history.length>5){historyGradient.classList.add('visible');}else{historyGradient.classList.remove('visible');}}
function openHistoryChat(chat){state.isViewingHistory=true;messagesArea.innerHTML='';if(chat.messages&&chat.messages.length>0){chat.messages.forEach(msg=>{const messageDiv=document.createElement('div');messageDiv.className=`message-wrapper ${msg.isUser?'user':'bot'}`;const avatar=msg.isUser?'https://static.tildacdn.com/tild6464-3166-4333-a465-316436316562/avatar.png':'https://static.tildacdn.com/tild6432-3465-4036-b232-396631303438/ita.png';messageDiv.innerHTML=`<img src="${avatar}" alt="${msg.isUser?'Вы':'Ита'}" class="message-avatar"><div class="message-content"><div class="message-sender">${msg.isUser?'Вы':'Ита'}</div><div class="message-bubble">${msg.text}</div>${msg.hint?`<div class="message-hint">${msg.hint}</div>`:''}</div>`;messagesArea.appendChild(messageDiv);});}
if(chat.links&&chat.links.length>0){const container=document.createElement('div');container.className='partner-links-container';chat.links.forEach(link=>{const linkElement=document.createElement('a');linkElement.href=link.url;linkElement.target='_blank';linkElement.rel='noopener noreferrer';linkElement.className='partner-link-button';linkElement.innerHTML=`<span class="partner-link-text">${link.text}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>`;container.appendChild(linkElement);});messagesArea.appendChild(container);}
scrollToBottom();renderQuickReplies();}
function returnToCurrentChat(){state.isViewingHistory=false;messagesArea.innerHTML='';init();}
function addMessage(text,isUser,hint=null){const messageDiv=document.createElement('div');messageDiv.className=`message-wrapper ${isUser?'user':'bot'}`;const avatar=isUser?'https://static.tildacdn.com/tild6464-3166-4333-a465-316436316562/avatar.png':'https://static.tildacdn.com/tild6432-3465-4036-b232-396631303438/ita.png';messageDiv.innerHTML=`<img src="${avatar}" alt="${isUser?'Вы':'Ита'}" class="message-avatar"><div class="message-content"><div class="message-sender">${isUser?'Вы':'Ита'}</div><div class="message-bubble">${text}</div>${hint?`<div class="message-hint">${hint}</div>`:''}</div>`;messagesArea.appendChild(messageDiv);state.chatMessages.push({text,isUser,hint});scrollToBottom();}
function addPartnerLinks(destination,budgetType,budgetPerPerson,dateFrom,dateTo,fromCity,wantsExcursions,iataCode,arrivalCity){const container=document.createElement('div');container.className='partner-links-container';const isLowBudget=budgetPerPerson==="До 50к";const transportRestrictions=state.answers[21]||"Нет";const noPlanes=transportRestrictions==="Не летаю";const noBuses=transportRestrictions==="Не езжу на автобусах";const majorCity=getNearestMajorCity(fromCity);const fromCityTranslit=transliterate(fromCity).toLowerCase();const fromCityCapitalized=capitalizeFirstLetter(transliterate(fromCity));const isDestinationMoscowOrSpb=destination.toLowerCase()==='москва'||destination.toLowerCase()==='санкт-петербург'||destination.toLowerCase()==='петербург';let airportData=findAirportCode(destination);let toCode=airportData?airportData.code:null;let destTranslit=airportData?airportData.translitLower:transliterate(destination).toLowerCase();let destCountry=airportData?(window.COUNTRY_CODES?(window.COUNTRY_CODES[airportData.country]||"russia"):"russia"):"russia";let destinationCapitalized=capitalizeFirstLetter(transliterate(destination));console.log('=== ГЕНЕРАЦИЯ ССЫЛОК ===');console.log('Направление:',destination);console.log('Код аэропорта ИЗ БАЗЫ:',toCode);console.log('Город прилета:',arrivalCity);console.log('Транслит:',destTranslit);console.log('Страна:',destCountry);console.log('Москва/СПБ как направление:',isDestinationMoscowOrSpb);console.log('Ограничения по транспорту:',transportRestrictions);const dateFromObj=new Date(dateFrom);const dateToObj=new Date(dateTo);const departDay=String(dateFromObj.getDate()).padStart(2,'0');const departMonth=String(dateFromObj.getMonth()+1).padStart(2,'0');const departYear=dateFromObj.getFullYear();const returnDay=String(dateToObj.getDate()).padStart(2,'0');const returnMonth=String(dateToObj.getMonth()+1).padStart(2,'0');const returnYear=dateToObj.getFullYear();if(noPlanes){const trainDepartDate=`${departDay}.${departMonth}.${departYear}`;const trainReturnDate=`${returnDay}.${returnMonth}.${returnYear}`;const trainLinkThere=`https://tp.media/r?campaign_id=45&erid=2Vtzqv4JEcW&marker=489850&p=1294&trs=465622&u=https%3A%2F%2Fwww.tutu.ru%2Fpoezda%2F${fromCityCapitalized}%2F${destinationCapitalized}%2F%3Fdate%3D${trainDepartDate}%26travelers%3D${state.adultsCount||1}`;container.innerHTML+=`<a href="${trainLinkThere}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Поезд ${fromCity} → ${destination}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;const trainLinkBack=`https://tp.media/r?campaign_id=45&erid=2Vtzqv4JEcW&marker=489850&p=1294&trs=465622&u=https%3A%2F%2Fwww.tutu.ru%2Fpoezda%2F${destinationCapitalized}%2F${fromCityCapitalized}%2F%3Fdate%3D${trainReturnDate}%26travelers%3D${state.adultsCount||1}`;container.innerHTML+=`<a href="${trainLinkBack}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Поезд ${destination} → ${fromCity}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;console.log('✅ Добавлены ссылки на поезда (ограничение: не летаю)');}
if(noBuses&&fromCity.toLowerCase()!=='москва'&&fromCity.toLowerCase()!=='санкт-петербург'&&fromCity.toLowerCase()!=='петербург'){const trainToMajorCityDate=`${departDay}.${departMonth}.${departYear}`;const trainFromMajorCityDate=`${returnDay}.${returnMonth}.${returnYear}`;const trainToMajorCityLink=`https://tp.media/r?campaign_id=45&erid=2Vtzqv4JEcW&marker=489850&p=1294&trs=465622&u=https%3A%2F%2Fwww.tutu.ru%2Fpoezda%2F${fromCityCapitalized}%2F${majorCity.name==='Москва'?'Moscow':'Saint-Petersburg'}%2F%3Fdate%3D${trainToMajorCityDate}%26travelers%3D${state.adultsCount||1}`;container.innerHTML+=`<a href="${trainToMajorCityLink}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Поезд ${fromCity} → ${majorCity.name}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;const trainFromMajorCityLink=`https://tp.media/r?campaign_id=45&erid=2Vtzqv4JEcW&marker=489850&p=1294&trs=465622&u=https%3A%2F%2Fwww.tutu.ru%2Fpoezda%2F${majorCity.name==='Москва'?'Moscow':'Saint-Petersburg'}%2F${fromCityCapitalized}%2F%3Fdate%3D${trainFromMajorCityDate}%26travelers%3D${state.adultsCount||1}`;container.innerHTML+=`<a href="${trainFromMajorCityLink}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Поезд ${majorCity.name} → ${fromCity}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;console.log('✅ Добавлены ссылки на поезда до крупного города (ограничение: не езжу на автобусах)');}
if(!noPlanes&&!isDestinationMoscowOrSpb&&toCode&&toCode!=="XXX"&&toCode.length===3){const aviasalesLink=`https://tp.media/r?campaign_id=100&erid=2Vtzqug4RPL&marker=489850&p=4114&trs=465622&u=https%3A%2F%2Fwww.aviasales.ru%2Fsearch%2F${majorCity.code}${departDay}${departMonth}${toCode}${returnDay}${returnMonth}1`;container.innerHTML+=`<a href="${aviasalesLink}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Авиабилеты ${majorCity.name} → ${arrivalCity||destination}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;console.log('✅ Добавлена ссылка на Aviasales');}else if(!noPlanes){console.log('❌ Aviasales не добавлен (Москва/СПБ или код отсутствует):',{isDestinationMoscowOrSpb,toCode});}
if(!noBuses&&arrivalCity&&arrivalCity.toLowerCase()!==destination.toLowerCase()){const arrivalCityTranslit=transliterate(arrivalCity).toLowerCase();const destinationTranslit=transliterate(destination).toLowerCase();const departDateYandex=`${dateFromObj.getFullYear()}-${departMonth}-${departDay}`;const returnDateYandex=`${dateToObj.getFullYear()}-${returnMonth}-${returnDay}`;const timestamp=Date.now();const yandexLinkToDestination=`https://tp.media/r?campaign_id=193&erid=2Vtzqxm3PnX&marker=489850&p=5916&trs=465622&u=https%3A%2F%2Ftravel.yandex.ru%2Fbuses%2F${arrivalCityTranslit}--${destinationTranslit}%2F%3Fdate%3D${departDateYandex}%26lastSearchTimeMarker%3D${timestamp}`;container.innerHTML+=`<a href="${yandexLinkToDestination}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Автобус ${arrivalCity} → ${destination}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;const yandexLinkFromDestination=`https://tp.media/r?campaign_id=193&erid=2Vtzqxm3PnX&marker=489850&p=5916&trs=465622&u=https%3A%2F%2Ftravel.yandex.ru%2Fbuses%2F${destinationTranslit}--${arrivalCityTranslit}%2F%3Fdate%3D${returnDateYandex}%26lastSearchTimeMarker%3D${timestamp}`;container.innerHTML+=`<a href="${yandexLinkFromDestination}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Автобус ${destination} → ${arrivalCity}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;console.log('✅ Добавлены ссылки на автобусы до места назначения');}
if(!noBuses&&fromCity.toLowerCase()!=='москва'&&fromCity.toLowerCase()!=='санкт-петербург'&&fromCity.toLowerCase()!=='петербург'){const departDateYandex=`${dateFromObj.getFullYear()}-${departMonth}-${departDay}`;const returnDateYandex=`${dateToObj.getFullYear()}-${returnMonth}-${returnDay}`;const timestamp=Date.now();const yandexLinkThere=`https://tp.media/r?campaign_id=193&erid=2Vtzqxm3PnX&marker=489850&p=5916&trs=465622&u=https%3A%2F%2Ftravel.yandex.ru%2Fbuses%2F${fromCityTranslit}--${majorCity.translit}%2F%3Fdate%3D${departDateYandex}%26lastSearchTimeMarker%3D${timestamp}`;container.innerHTML+=`<a href="${yandexLinkThere}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Автобус ${fromCity} → ${majorCity.name}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;const yandexLinkBack=`https://tp.media/r?campaign_id=193&erid=2Vtzqxm3PnX&marker=489850&p=5916&trs=465622&u=https%3A%2F%2Ftravel.yandex.ru%2Fbuses%2F${majorCity.translit}--${fromCityTranslit}%2F%3Fdate%3D${returnDateYandex}%26lastSearchTimeMarker%3D${timestamp}`;container.innerHTML+=`<a href="${yandexLinkBack}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Автобус ${majorCity.name} → ${fromCity}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;console.log('✅ Добавлены ссылки на автобусы до крупного города');}
if(!isLowBudget&&destCountry&&destTranslit){const checkInDate=new Date(dateFromObj);checkInDate.setDate(checkInDate.getDate()+1);const checkOutDate=new Date(dateToObj);checkOutDate.setDate(checkOutDate.getDate()-1);const dateRange=`${formatDate(checkInDate,'dd.MM.yyyy')}-${formatDate(checkOutDate,'dd.MM.yyyy')}`;let guestsParam=String(state.adultsCount||1);if(state.childrenAges&&state.childrenAges.length>0){const childrenAgesStr=state.childrenAges.map(age=>age).join('.');guestsParam+=`and${childrenAgesStr}`;}
const ostrovokLink=`https://tp.media/r?campaign_id=459&erid=2VtzqxJSzRD&marker=489850&p=7038&trs=465622&u=https%3A%2F%2Fostrovok.ru%2Fhotel%2F${destCountry}%2F${destTranslit}%2F%3Fdates%3D${dateRange}%26guests%3D${guestsParam}%26q%3D5580%26search%3Dyes%26sid%3Da218a0b4-98d6-4712-b029-b5eb0feecc15`;container.innerHTML+=`<a href="${ostrovokLink}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Проживание в ${destination}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;console.log('✅ Добавлена ссылка на Ostrovok');}else{console.log('❌ Ostrovok не добавлен:',{isLowBudget,destCountry,destTranslit});}
if(wantsExcursions&&destTranslit){const excursionDate=new Date(dateFromObj);excursionDate.setDate(excursionDate.getDate()+1);const excursionDateISO=excursionDate.toISOString();const sputnikLink=`https://tp.media/r?campaign_id=21&erid=2VtzqumzNWi&marker=489850&p=656&trs=465622&u=https%3A%2F%2Fwww.sputnik8.com%2Fru%2F${destTranslit}%3FdateTo%3D${excursionDateISO}%26filters%3DdateFrom%253D${excursionDateISO}`;container.innerHTML+=`<a href="${sputnikLink}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Экскурсии в ${destination}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;console.log('✅ Добавлена ссылка на Sputnik');}
if(container.innerHTML===''){console.log('⚠️ Ни одна ссылка не добавлена, показываем Avito');container.innerHTML=`<a href="https://www.avito.ru/rossiya/nedvizhimost/posutochno?q=${encodeURIComponent(destination)}" target="_blank" rel="noopener noreferrer" class="partner-link-button"><span class="partner-link-text">Найти жилье на Авито в ${destination}</span><svg class="partner-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>`;}
messagesArea.appendChild(container);state.partnerLinks=Array.from(container.querySelectorAll('a')).map(link=>({text:link.querySelector('.partner-link-text').textContent,url:link.href}));console.log('Всего добавлено ссылок:',state.partnerLinks.length);scrollToBottom();}
function formatDate(date,formatStr){const day=String(date.getDate()).padStart(2,'0');const month=String(date.getMonth()+1).padStart(2,'0');const year=date.getFullYear();if(formatStr==='dd.MM.yyyy'){return`${day}.${month}.${year}`;}else if(formatStr==='yyyy-MM-dd'){return`${year}-${month}-${day}`;}else if(formatStr==='ddMMyyyy'){return`${day}${month}${year}`;}
return date.toISOString().split('T')[0];}
function addLoadingMessage(){const messageDiv=document.createElement('div');messageDiv.className='message-wrapper bot';messageDiv.id='loadingMessage';messageDiv.innerHTML=`<img src="https://static.tildacdn.com/tild6432-3465-4036-b232-396631303438/ita.png" alt="Ита" class="message-avatar"><div class="message-content"><div class="message-sender">Ита</div><div class="message-bubble"><div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div></div></div>`;messagesArea.appendChild(messageDiv);scrollToBottom();}
function removeLoadingMessage(){const loadingMsg=document.getElementById('loadingMessage');if(loadingMsg){loadingMsg.remove();}}
function scrollToBottom(){messagesArea.scrollTop=messagesArea.scrollHeight;}
function renderQuickReplies(){quickReplies.innerHTML='';if(state.isViewingHistory){const backBtn=document.createElement('button');backBtn.className='quick-reply-btn';backBtn.textContent='Вернуться к текущему чату';backBtn.onclick=returnToCurrentChat;quickReplies.appendChild(backBtn);return;}
if(!state.isSurveyStarted&&!state.isBriefCompleted){const btn=document.createElement('button');btn.className='quick-reply-btn';btn.textContent='Да, начать опрос';btn.onclick=handleStartSurvey;quickReplies.appendChild(btn);if(!isAlternativeScenario){const btnAlternative=document.createElement('button');btnAlternative.className='quick-reply-btn';btnAlternative.textContent='Я уже знаю, куда поеду';btnAlternative.onclick=()=>{window.location.href='?non';};quickReplies.appendChild(btnAlternative);}else{const searchNewBtn=document.createElement('button');searchNewBtn.className='quick-reply-btn';searchNewBtn.textContent='Искать новое место';searchNewBtn.onclick=()=>{window.location.href='?newchat';};quickReplies.appendChild(searchNewBtn);}}else if(state.isBriefCompleted&&state.currentProposals.length>0&&!state.selectedProposal){state.currentProposals.forEach((proposal,index)=>{const btn=document.createElement('button');btn.className='quick-reply-btn';btn.textContent=`Вариант ${index+1}: ${proposal.destination}`;btn.onclick=()=>handleProposalSelect(index);quickReplies.appendChild(btn);});const findOtherBtn=document.createElement('button');findOtherBtn.className='quick-reply-btn';findOtherBtn.textContent='Найти другие варианты';findOtherBtn.onclick=handleFindOther;quickReplies.appendChild(findOtherBtn);if(isAlternativeScenario){const searchNewBtn=document.createElement('button');searchNewBtn.className='quick-reply-btn';searchNewBtn.textContent='Искать новое место';searchNewBtn.onclick=()=>{window.location.href='?newchat';};quickReplies.appendChild(searchNewBtn);}}else if(state.isBriefCompleted&&state.selectedProposal){const findOtherBtn=document.createElement('button');findOtherBtn.className='quick-reply-btn';findOtherBtn.textContent='Найти другие варианты';findOtherBtn.onclick=handleFindOther;quickReplies.appendChild(findOtherBtn);if(isAlternativeScenario){const searchNewBtn=document.createElement('button');searchNewBtn.className='quick-reply-btn';searchNewBtn.textContent='Искать новое место';searchNewBtn.onclick=()=>{window.location.href='?newchat';};quickReplies.appendChild(searchNewBtn);}}
if(state.hasHealthWarning){const healthRecommendationBtn=document.createElement('button');healthRecommendationBtn.className='quick-reply-btn';healthRecommendationBtn.textContent='Дать рекомендуемые варианты';healthRecommendationBtn.onclick=handleHealthRecommendations;quickReplies.appendChild(healthRecommendationBtn);}}
function handleStartSurvey(){addMessage("Да, начать опрос",true);state.isSurveyStarted=true;renderQuickReplies();setTimeout(()=>{showNextQuestion();scrollToBottom();},300);}
function showNextQuestion(startIndex){let nextIndex=startIndex!==undefined?startIndex:state.currentQuestionIndex;while(nextIndex<questions.length){const question=questions[nextIndex];if(question.showIf&&!question.showIf(state.answers)){nextIndex++;continue;}
if(state.currentQuestionIndex<questions.length){state.shownQuestions.push(state.currentQuestionIndex);}
state.currentQuestionIndex=nextIndex;showCurrentQuestion();renderInputArea();updateProgress();return;}
completeBrief();}
function checkHealthWarnings(){if(hasAllergyAndLocalCuisine(state.answers)){state.hasHealthWarning=true;state.healthWarningType='allergy';addMessage("Я рекомендую тебе посмотреть другие варианты – местная кухня часто содержит множество различных аллергенов. В рекомендациях обязательно напишу: Взять противоаллергенные лекарственные средства.",false);renderQuickReplies();return;}
if(hasBeachWithHealthIssues(state.answers)){state.hasHealthWarning=true;state.healthWarningType='beach_health';addMessage("Крайне рекомендую выбрать климатическую зону холоднее – это поможет сохранить твое здоровье.",false);renderQuickReplies();return;}
if(hasActiveTourWithHealthIssues(state.answers)){state.hasHealthWarning=true;state.healthWarningType='active_health';addMessage("Крайне рекомендую выбрать климатическую зону холоднее – это поможет сохранить твое здоровье.",false);renderQuickReplies();return;}
state.hasHealthWarning=false;setTimeout(()=>{showNextQuestion(state.currentQuestionIndex+1);scrollToBottom();},300);}
function handleHealthRecommendations(){state.hasHealthWarning=false;let healthPrompt="У клиента есть ограничения по здоровью: ";if(state.healthWarningType==='allergy'){healthPrompt+="аллергия на часть продуктов. Клиент выбрал 'Местная кухня', но это может быть опасно. ";healthPrompt+="Предложи безопасные альтернативы с учетом аллергии. Обязательно укажи: Взять противоаллергенные лекарственные средства. ";}else if(state.healthWarningType==='beach_health'){const healthIssue=state.answers[22];healthPrompt+=`${healthIssue}. Клиент выбрал пляжный отдых и любит жаркую погоду, но это может усугубить состояние. `;healthPrompt+="Предложи направления с более мягким климатом, подходящие для людей с такими заболеваниями. ";}else if(state.healthWarningType==='active_health'){const travelPurpose=state.answers[7];healthPrompt+=`заболевания опорно-двигательного аппарата. Клиент выбрал ${travelPurpose}, но это может быть опасно. `;healthPrompt+="Предложи более безопасные альтернативы активного отдыха или направления с щадящими условиями. "}
healthPrompt+="Учитывай все остальные предпочтения клиента из анкеты. ";healthPrompt+="Предложи 3 безопасных варианта с подробным обоснованием почему они подходят.";state.isLoading=true;addLoadingMessage();fetch("https://functions.yandexcloud.net/d4e3fempk5bopa9943rp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:healthPrompt,history:[]})}).then(response=>response.json()).then(data=>{state.isLoading=false;removeLoadingMessage();if(data.reply){addMessage(data.reply,false);const proposals=parseProposalsFromGPT(data.reply);if(proposals.length>0){state.currentProposals=proposals;state.isBriefCompleted=true;renderQuickReplies();}}}).catch(error=>{state.isLoading=false;removeLoadingMessage();console.error("Ошибка:",error);addMessage("Ошибка получения рекомендаций",false);});}
function showCurrentQuestion(){const question=questions[state.currentQuestionIndex];addMessage(question.text,false,question.hint);}
function renderInputArea(){const question=questions[state.currentQuestionIndex];inputArea.innerHTML='';if(!question)return;if(question.type==='text'){renderTextInput();}else if(question.type==='single'){renderSingleChoice();}else if(question.type==='multi'){renderMultiChoice();}else if(question.type==='counter'){renderCounter();}else if(question.type==='counter_with_ages'){renderCounterWithAges();}else if(question.type==='date'){renderDatePicker();}else if(question.type==='additional_preferences'){renderAdditionalPreferences();}}
function renderAdditionalPreferences(){const container=document.createElement('div');let html='';if(state.shownQuestions.length>0){html+='<button class="back-btn" onclick="handleBack()">Назад</button>';}
html+=`<div class="additional-preferences-container"><div class="additional-preferences-wrapper"><input type="text" class="additional-preferences-input" id="additionalPreferencesField" placeholder="Напиши свои пожелания (необязательно)..." /><button class="additional-preferences-send-btn" onclick="handleAdditionalPreferences()">Продолжить</button></div></div>`;container.innerHTML=html;inputArea.appendChild(container);const inputField=document.getElementById('additionalPreferencesField');inputField.addEventListener('keypress',(e)=>{if(e.key==='Enter')handleAdditionalPreferences();});inputField.focus();}
function handleAdditionalPreferences(){const inputField=document.getElementById('additionalPreferencesField');const value=inputField.value.trim();if(value){addMessage(value,true);state.answers[state.currentQuestionIndex]=value;}else{addMessage("Пропустить",true);state.answers[state.currentQuestionIndex]="";}
setTimeout(()=>{showNextQuestion(state.currentQuestionIndex+1);scrollToBottom();},300);}
function renderTextInput(){const container=document.createElement('div');let html='';if(state.shownQuestions.length>0){html+='<button class="back-btn" onclick="handleBack()">Назад</button>';}
html+=`<div class="input-container"><input type="text" class="text-input" id="textInputField" placeholder="Введи сообщение..." /><button class="send-btn" onclick="handleTextInput()">Отправить</button></div>`;container.innerHTML=html;inputArea.appendChild(container);const inputField=document.getElementById('textInputField');inputField.addEventListener('keypress',(e)=>{if(e.key==='Enter')handleTextInput();});inputField.focus();}
function handleTextInput(){const inputField=document.getElementById('textInputField');const value=inputField.value.trim();if(value){addMessage(value,true);state.answers[state.currentQuestionIndex]=value;if(state.currentQuestionIndex===22){setTimeout(()=>{checkHealthWarnings();scrollToBottom();},300);}else{setTimeout(()=>{showNextQuestion(state.currentQuestionIndex+1);scrollToBottom();},300);}}}
function renderSingleChoice(){const container=document.createElement('div');const question=questions[state.currentQuestionIndex];const options=typeof question.options==='function'?question.options(state.answers):question.options;let html='<div>';options.forEach((option,index)=>{html+=`<button class="option-btn" onclick="handleSingleOption('${option.value.replace(/'/g,"\\'")}','${option.text.replace(/'/g,"\\'")}')"><span class="option-text">${option.text}</span></button>`;});html+='</div>';if(state.shownQuestions.length>0){html+='<button class="back-btn" onclick="handleBack()">Назад</button>';}
container.innerHTML=html;inputArea.appendChild(container);}
function handleSingleOption(value,text){addMessage(text,true);state.answers[state.currentQuestionIndex]=value;if(state.currentQuestionIndex===22){setTimeout(()=>{checkHealthWarnings();scrollToBottom();},300);}else{setTimeout(()=>{showNextQuestion(state.currentQuestionIndex+1);scrollToBottom();},300);}}
function renderMultiChoice(){const container=document.createElement('div');const question=questions[state.currentQuestionIndex];const options=typeof question.options==='function'?question.options(state.answers):question.options;let html='<div class="checkbox-list">';options.forEach((option,index)=>{const isChecked=state.selectedMultiple.includes(option.value);html+=`<label class="checkbox-label"><input type="checkbox" class="checkbox-input" value="${option.value}" ${isChecked?'checked':''} onchange="handleMultiToggle('${option.value}')"><span class="checkbox-text">${option.text}</span></label>`;});html+='</div>';html+='<div class="button-row">';if(state.shownQuestions.length>0){html+='<button class="back-btn" onclick="handleBack()">Назад</button>';}
html+='<button class="continue-btn" onclick="handleMultiContinue()">Продолжить</button>';html+='</div>';container.innerHTML=html;inputArea.appendChild(container);}
function handleMultiToggle(value){const index=state.selectedMultiple.indexOf(value);if(index>-1){state.selectedMultiple.splice(index,1);}else{state.selectedMultiple.push(value);}}
function handleMultiContinue(){if(state.selectedMultiple.length>0){const text=state.selectedMultiple.join(', ');addMessage(text,true);state.answers[state.currentQuestionIndex]=[...state.selectedMultiple];state.selectedMultiple=[];if(state.currentQuestionIndex===22){setTimeout(()=>{checkHealthWarnings();scrollToBottom();},300);}else{setTimeout(()=>{showNextQuestion(state.currentQuestionIndex+1);scrollToBottom();},300);}}}
function renderCounter(){const container=document.createElement('div');let html='<div>';html+=`<div class="counter-row"><span class="counter-label">Количество человек:</span><div class="counter-controls"><button class="counter-btn" onclick="changeAdultsCount(-1)">-</button><span class="counter-value" id="adultsCount">${state.adultsCount}</span><button class="counter-btn" onclick="changeAdultsCount(1)">+</button></div></div>`;html+='</div>';html+='<div class="button-row">';if(state.shownQuestions.length>0){html+='<button class="back-btn" onclick="handleBack()">Назад</button>';}
html+='<button class="continue-btn" onclick="handleCounterContinue()">Продолжить</button>';html+='</div>';container.innerHTML=html;inputArea.appendChild(container);}
function renderCounterWithAges(){const container=document.createElement('div');let html='<div>';html+=`<div class="counter-row"><span class="counter-label">Взрослые:</span><div class="counter-controls"><button class="counter-btn" onclick="changeAdultsCount(-1)">-</button><span class="counter-value" id="adultsCount">${state.adultsCount}</span><button class="counter-btn" onclick="changeAdultsCount(1)">+</button></div></div>`;if(state.childrenAges.length>0){html+='<div class="children-list" id="childrenList">';state.childrenAges.forEach((age,index)=>{html+=`<div class="child-item"><span class="child-age-label">Ребенок ${index+1}: ${age} лет</span><button class="remove-child-btn" data-index="${index}">Удалить</button></div>`;});html+='</div>';}
if(!state.showAgeSelector){html+='<button class="add-child-btn" onclick="showAgeSelector()">Добавить ребенка</button>';}else{html+='<div class="age-selector">';html+='<div class="age-selector-label">Выберите возраст ребенка:</div>';html+='<div class="age-options">';for(let age=5;age<=17;age++){html+=`<button class="age-option-btn" onclick="addChildAge(${age})">${age}</button>`;}
html+='</div>';html+='</div>';}
html+='</div>';html+='<div class="button-row">';if(state.shownQuestions.length>0){html+='<button class="back-btn" onclick="handleBack()">Назад</button>';}
html+='<button class="continue-btn" onclick="handleCounterWithAgesContinue()">Продолжить</button>';html+='</div>';container.innerHTML=html;inputArea.appendChild(container);const removeButtons=container.querySelectorAll('.remove-child-btn');removeButtons.forEach(btn=>{btn.addEventListener('click',function(){const index=parseInt(this.getAttribute('data-index'));removeChild(index);});});}
function showAgeSelector(){state.showAgeSelector=true;renderInputArea();}
function addChildAge(age){state.childrenAges.push(age);state.childrenCount=state.childrenAges.length;state.showAgeSelector=false;renderInputArea();}
function removeChild(index){state.childrenAges.splice(index,1);state.childrenCount=state.childrenAges.length;renderInputArea();}
function changeAdultsCount(delta){state.adultsCount=Math.max(1,state.adultsCount+delta);document.getElementById('adultsCount').textContent=state.adultsCount;}
function handleCounterContinue(){addMessage(`Количество человек: ${state.adultsCount}`,true);state.answers[state.currentQuestionIndex]={adults:state.adultsCount,children:0};setTimeout(()=>{showNextQuestion(state.currentQuestionIndex+1);scrollToBottom();},300);}
function handleCounterWithAgesContinue(){const childrenText=state.childrenAges.length>0?`, Дети: ${state.childrenAges.join(', ')} лет`:'';addMessage(`Взрослые: ${state.adultsCount}${childrenText}`,true);state.answers[state.currentQuestionIndex]={adults:state.adultsCount,children:state.childrenCount,childrenAges:[...state.childrenAges]};setTimeout(()=>{showNextQuestion(state.currentQuestionIndex+1);scrollToBottom();},300);}
function getDefaultFromDate(){const date=new Date();date.setDate(date.getDate()+14);date.setHours(0,0,0,0);return date;}
function getDefaultToDate(){const date=new Date();date.setDate(date.getDate()+21);date.setHours(0,0,0,0);return date;}
function renderDatePicker(){if(!state.dateFrom)state.dateFrom=getDefaultFromDate();if(!state.dateTo)state.dateTo=getDefaultToDate();const container=document.createElement('div');let html='<div>';html+=`<div class="date-inputs"><div class="date-input-wrapper"><button class="date-btn" onclick="toggleDateFromPicker()"><svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span id="dateFromText">${formatDate(state.dateFrom,'dd.MM.yyyy')}</span></button><div id="dateFromPicker" style="display: none;"></div></div><div class="date-input-wrapper"><button class="date-btn" onclick="toggleDateToPicker()"><svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span id="dateToText">${formatDate(state.dateTo,'dd.MM.yyyy')}</span></button><div id="dateToPicker" style="display: none;"></div></div></div>`;html+='</div>';html+='<div class="button-row">';if(state.shownQuestions.length>0){html+='<button class="back-btn" onclick="handleBack()">Назад</button>';}
html+='<button class="continue-btn" onclick="handleDateContinue()">Продолжить</button>';html+='</div>';container.innerHTML=html;inputArea.appendChild(container);}
function toggleDateFromPicker(){state.showDateFromPicker=!state.showDateFromPicker;state.showDateToPicker=false;if(state.showDateFromPicker){renderCalendar('dateFromPicker','from');}else{document.getElementById('dateFromPicker').style.display='none';}
document.getElementById('dateToPicker').style.display='none';}
function toggleDateToPicker(){state.showDateToPicker=!state.showDateToPicker;state.showDateFromPicker=false;if(state.showDateToPicker){renderCalendar('dateToPicker','to');}else{document.getElementById('dateToPicker').style.display='none';}
document.getElementById('dateFromPicker').style.display='none';}
function renderCalendar(elementId,type){const container=document.getElementById(elementId);const currentDate=state.currentCalendarMonth;const year=currentDate.getFullYear();const month=currentDate.getMonth();const firstDay=new Date(year,month,1);const lastDay=new Date(year,month+1,0);const daysInMonth=lastDay.getDate();let startDay=firstDay.getDay()-1;if(startDay<0)startDay=6;const days=[];for(let i=0;i<startDay;i++){days.push(null);}
for(let i=1;i<=daysInMonth;i++){days.push(i);}
const today=new Date();today.setHours(0,0,0,0);let html='<div class="calendar">';html+='<div class="calendar-header">';html+=`<button class="calendar-nav-btn prev" onclick="changeCalendarMonth(-1,'${elementId}','${type}')">‹</button>`;html+=`<div class="calendar-title">${MONTHS_RU[month]} ${year}</div>`;html+=`<button class="calendar-nav-btn next" onclick="changeCalendarMonth(1,'${elementId}','${type}')">›</button>`;html+='</div>';html+='<div class="calendar-days-header">';DAYS_SHORT.forEach(day=>{html+=`<div class="calendar-day-label">${day}</div>`;});html+='</div>';html+='<div class="calendar-days">';days.forEach((day,index)=>{if(day){const date=new Date(year,month,day);date.setHours(0,0,0,0);const isSelected=(type==='from'&&state.dateFrom&&date.getTime()===state.dateFrom.getTime())||(type==='to'&&state.dateTo&&date.getTime()===state.dateTo.getTime());const isToday=date.getTime()===today.getTime();const isPast=date.getTime()<=today.getTime();let isBeforeFrom=false;if(type==='to'&&state.dateFrom){const fromDate=new Date(state.dateFrom);fromDate.setHours(0,0,0,0);isBeforeFrom=date.getTime()<fromDate.getTime();}
let isInRange=false;if(state.dateFrom&&state.dateTo){const fromTime=new Date(state.dateFrom).setHours(0,0,0,0);const toTime=new Date(state.dateTo).setHours(0,0,0,0);const dateTime=date.getTime();isInRange=dateTime>fromTime&&dateTime<toTime;}
let className='calendar-day';if(isPast||isBeforeFrom){className+=' disabled';}
if(isSelected)className+=' selected';else if(isToday&&!isPast)className+=' today';if(isInRange)className+=' in-range';const onclick=(isPast||isBeforeFrom)?'':`onclick="selectDate(${day},${month},${year},'${type}')"`;html+=`<button class="${className}" ${onclick}>${day}</button>`;}else{html+='<div class="calendar-day empty"></div>';}});html+='</div>';html+='</div>';container.innerHTML=html;container.style.display='block';}
function changeCalendarMonth(delta,elementId,type){const currentDate=state.currentCalendarMonth;state.currentCalendarMonth=new Date(currentDate.getFullYear(),currentDate.getMonth()+delta,1);renderCalendar(elementId,type);}
function selectDate(day,month,year,type){const date=new Date(year,month,day);date.setHours(0,0,0,0);const today=new Date();today.setHours(0,0,0,0);if(date.getTime()<=today.getTime()){return;}
if(type==='from'){state.dateFrom=date;document.getElementById('dateFromText').textContent=formatDate(date,'dd.MM.yyyy');document.getElementById('dateFromPicker').style.display='none';state.showDateFromPicker=false;if(state.dateTo&&state.dateTo.getTime()<date.getTime()){state.dateTo=null;document.getElementById('dateToText').textContent=formatDate(getDefaultToDate(),'dd.MM.yyyy');}}else{if(state.dateFrom&&date.getTime()<state.dateFrom.getTime()){return;}
state.dateTo=date;document.getElementById('dateToText').textContent=formatDate(date,'dd.MM.yyyy');document.getElementById('dateToPicker').style.display='none';state.showDateToPicker=false;}
if(state.showDateFromPicker){renderCalendar('dateFromPicker','from');}
if(state.showDateToPicker){renderCalendar('dateToPicker','to');}}
function handleDateContinue(){if(state.dateFrom&&state.dateTo){addMessage(`${formatDate(state.dateFrom,'dd.MM.yyyy')} - ${formatDate(state.dateTo,'dd.MM.yyyy')}`,true);state.answers[state.currentQuestionIndex]={from:formatDate(state.dateFrom,'yyyy-MM-dd'),to:formatDate(state.dateTo,'yyyy-MM-dd')};setTimeout(()=>{showNextQuestion(state.currentQuestionIndex+1);scrollToBottom();},300);}}
function handleBack(){if(state.shownQuestions.length>0){const lastQuestionIndex=state.shownQuestions.pop();delete state.answers[lastQuestionIndex];messagesArea.removeChild(messagesArea.lastChild);messagesArea.removeChild(messagesArea.lastChild);state.currentQuestionIndex=lastQuestionIndex;state.selectedMultiple=[];setTimeout(()=>{showCurrentQuestion();renderInputArea();updateProgress();},100);}}
function calculateDays(dateFrom,dateTo){const date1=new Date(dateFrom);const date2=new Date(dateTo);const diffTime=Math.abs(date2.getTime()-date1.getTime());const diffDays=Math.ceil(diffTime/(1000*60*60*24));return diffDays;}
function completeBrief(){state.isBriefCompleted=true;inputArea.innerHTML='';let summary="Отлично! Твои предпочтения:\n\n";Object.keys(state.answers).forEach(key=>{const answer=state.answers[key];if(typeof answer==='object'&&answer.from){const days=calculateDays(answer.from,answer.to);summary+=`• ${answer.from} - ${answer.to} (${days} дней)\n`;}else if(typeof answer==='object'&&answer.adults!==undefined){summary+=`• Взрослые: ${answer.adults}`;if(answer.children>0){summary+=`, Дети: ${answer.children}`;if(answer.childrenAges&&answer.childrenAges.length>0){summary+=` (${answer.childrenAges.join(', ')} лет)`;}}
summary+='\n';}else if(Array.isArray(answer)){summary+=`• ${answer.join(', ')}\n`;}else{summary+=`• ${answer}\n`;}});addMessage(summary,false);const gptPrompt=generateGPTPrompt();sendToGPT(gptPrompt);}
function generateGPTPrompt(){const additionalPreferences=state.answers[24]||"";if(state.isAlternativeScenario){const destination=state.answers[1];const fromCity=state.answers[0];const days=state.answers[5]?calculateDays(state.answers[5].from,state.answers[5].to):7;const majorCity=getNearestMajorCity(fromCity);const isDestinationMoscowOrSpb=destination.toLowerCase()==='москва'||destination.toLowerCase()==='санкт-петербург'||destination.toLowerCase()==='петербург';let prompt=`Ты профессиональный турагент. Всегда общайся с ним на "ты". Клиент хочет поехать в ${destination} из города ${fromCity} на ${days} дней.\n\nДАННЫЕ КЛИЕНТА:\n- Город проживания клиента: ${fromCity}\n- Ближайший аэропорт вылета: ${majorCity.name} (${majorCity.code})\n- Направление: ${destination}\n- Компания: ${state.answers[2]||'не указана'}`;if(state.answers[3]){prompt+=`\n- Количество: Взрослые - ${state.answers[3].adults}, Дети - ${state.answers[3].children}`;if(state.answers[3].childrenAges&&state.answers[3].childrenAges.length>0){prompt+=` (${state.answers[3].childrenAges.join(', ')} лет)`;}}else if(state.answers[4]){prompt+=`\n- Количество человек: ${state.answers[4].adults}`;}
prompt+=`\n- Тип бюджета: ${state.answers[6]||'не указан'}\n- Бюджет на человека: ${state.answers[7]||'не указан'}`;if(state.answers[5]){prompt+=`\n- Даты поездки: ${state.answers[5].from} - ${state.answers[5].to}`;prompt+=`\n- ПРОДОЛЖИТЕЛЬНОСТЬ: ${days} ДНЕЙ (это обязательное условие!)`;}
if(additionalPreferences){prompt+=`\n- Дополнительные пожелания: ${additionalPreferences}`;}
if(isDestinationMoscowOrSpb){prompt+=`\n\n⚠️ КРИТИЧЕСКИ ВАЖНО - НАПРАВЛЕНИЕ В МОСКВУ/СПБ:\n- Клиент живет в ${fromCity}, направление: ${destination}\n- САМОЛЕТ НЕ ИСПОЛЬЗУЕТСЯ (поездка внутри России в крупный город)\n- Используй ТОЛЬКО поезд или автобус\n- В программе НЕ УКАЗЫВАЙ перелеты\n- Начни маршрут с автобуса или поезда из ${fromCity} в ${destination}`;}else{prompt+=`\n\n⚠️ КРИТИЧЕСКИ ВАЖНЫЕ ТРЕБОВАНИЯ ПО ТРАНСПОРТУ И ЛОГИСТИКЕ:\n\n1. ОСНОВНОЕ ПЕРЕМЕЩЕНИЕ: ТОЛЬКО НА САМОЛЕТЕ\n\n2. ЛОГИСТИКА ОТ ДОМА КЛИЕНТА:\n   - Клиент живет в городе: ${fromCity}\n   - ВЫЛЕТ САМОЛЕТА СТРОГО из аэропорта: ${majorCity.name} (${majorCity.code})\n   ${fromCity.toLowerCase()!==majorCity.name.toLowerCase()?`- День 1: Клиент едет из ${fromCity} до ${majorCity.name} на автобусе/поезде`:''}\n   - Определи ближайший КРУПНЫЙ аэропорт к ${destination} для ПРИЛЕТА\n   \n3. АЭРОПОРТ ПРИЛЕТА:\n   - Ты ОБЯЗАН найти ближайший КРУПНЫЙ аэропорт к месту ${destination}\n   - КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО прилетать в маленькие города, если есть крупный аэропорт рядом\n   - Примеры ПРАВИЛЬНО:\n     * Алтай → прилет в Барнаул (BAX) или Новосибирск (OVB)\n     * Камчатка → Петропавловск-Камчатский (PKC)\n     * Байкал → Иркутск (IKT)\n   \n4. В ОТВЕТЕ ТЫ ОБЯЗАН УКАЗАТЬ:\n   - АЭРОПОРТ вылета: ${majorCity.name} (${majorCity.code})\n   - АЭРОПОРТ прилета с кодом (например: "Барнаул BAX")\n   ${fromCity.toLowerCase()!==majorCity.name.toLowerCase()?`- Как клиент доберется из ${fromCity} до ${majorCity.name}`:''}\n   - Если конечное место назначения не имеет аэропорта - указать трансфер`;}
prompt+=`\n\nПодбери 3 варианта программы в ${destination} с учетом всех предпочтений.\n\nФОРМАТ ОТВЕТА (строго соблюдай этот формат!):\n1. Напиши краткое вступление (1-2 предложения) в дружелюбном тоне\n2. Затем обязательно напиши каждый вариант в таком формате:\n\nВариант 1: [КОНКРЕТНЫЙ ГОРОД НАЗНАЧЕНИЯ]\n${isDestinationMoscowOrSpb?'Маршрут: [транспорт из города вылета]':'Перелет: [Город вылета CODE] → [Город прилета CODE]'}\n[2-3 предложения почему этот вариант подходит]\n\nВариант 2: [КОНКРЕТНЫЙ ГОРОД НАЗНАЧЕНИЯ]\n${isDestinationMoscowOrSpb?'Маршрут: [транспорт из города вылета]':'Перелет: [Город вылета CODE] → [Город прилета CODE]'}\n[2-3 предложения почему этот вариант подходит]\n\nВариант 3: [КОНКРЕТНЫЙ ГОРОД НАЗНАЧЕНИЯ]\n${isDestinationMoscowOrSpb?'Маршрут: [транспорт из города вылета]':'Перелет: [Город вылета CODE] → [Город прилета CODE]'}\n[2-3 предложения почему этот вариант подходит]\n\n3. НЕ пиши подробную программу сейчас - она будет запрошена отдельно при выборе варианта\n4. Обязательно используй слово "Вариант" и номер`;return prompt;}else{const days=state.answers[4]?calculateDays(state.answers[4].from,state.answers[4].to):7;const transportRestrictions=state.answers[21]||"Нет";const canFly=transportRestrictions!=="Не летаю";const direction=state.answers[23]||"Не важно";const fromCity=state.answers[0]||'не указан';const majorCity=getNearestMajorCity(fromCity);let prompt=`Ты профессиональный турагент. Всегда общайся на "ты". На основе анкеты клиента подбери 3 конкретных варианта программы с реальными городами.\n\nВАЖНО: Все программы должны быть рассчитаны СТРОГО на ${days} дней поездки.\n\nДАННЫЕ КЛИЕНТА:\n- Город проживания клиента: ${fromCity}\n- Ближайший аэропорт вылета: ${majorCity.name} (${majorCity.code})\n- Состав компании: ${state.answers[1]||'не указан'}`;if(state.answers[4]){const days=calculateDays(state.answers[4].from,state.answers[4].to);prompt+=`\n- Даты поездки: ${state.answers[4].from} - ${state.answers[4].to}`;prompt+=`\n- ПРОДОЛЖИТЕЛЬНОСТЬ: ${days} ДНЕЙ (это обязательное условие!)`;}
prompt+=`\n- Тип бюджета: ${state.answers[5]||'не указан'}\n- Бюджет на человека: ${state.answers[6]||'не указан'}\n- Основная цель поездки: ${state.answers[7]||'не указана'}\n- Направление: ${direction}`;if(additionalPreferences){prompt+=`\n- Дополнительные пожелания: ${additionalPreferences}`;}
prompt+=`\n\n⚠️ СТРОГИЕ ПРАВИЛА ПО КАТЕГОРИЯМ НАПРАВЛЕНИЙ:\n\n1. "Россия" = ТОЛЬКО города и регионы России (Алтай, Байкал, Сочи, Карелия, Камчатка и т.д.)\n\n2. "Ближнее зарубежье" = ТОЛЬКО страны СНГ КРОМЕ России:\n   - Казахстан (Алматы, Астана)\n   - Узбекистан (Самарканд, Бухара, Ташкент)\n   - Киргизия (Бишкек, Иссык-Куль)\n   - Грузия (Тбилиси, Батуми)\n   - Армения (Ереван)\n   - Азербайджан (Баку)\n   - Беларусь (Минск)\n   - предлагай не только перечисленные города, но и другие\n   \n3. "Азия" = Азиатские страны КРОМЕ СНГ:\n   - Турция, Таиланд, Вьетнам, Китай, Япония, ОАЭ, Индия и т.д.\n   - КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО включать страны СНГ в эту категорию!\n\n4. "Европа" = Европейские страны (Италия, Франция, Испания и т.д.)\n5. "Не важно" = НЕ ПРЕДЛАГАЙ ГОРОДА В РОССИИ, ЕСЛИ ВЫБРАНО "Жарко" или "Тепло"\n\nКАТЕГОРИИ НЕ ПЕРЕСЕКАЮТСЯ! Если клиент выбрал "Азия" - НЕ предлагай страны СНГ!`;prompt+=`\n\n⚠️ КРИТИЧЕСКИ ВАЖНЫЕ ТРЕБОВАНИЯ ПО ТРАНСПОРТУ И ЛОГИСТИКЕ:\n\n1. ОСНОВНОЕ ПЕРЕМЕЩЕНИЕ: ${canFly?'ТОЛЬКО НА САМОЛЕТЕ':'БЕЗ САМОЛЕТОВ (поезд/автобус)'}\n\n2. ЛОГИСТИКА ОТ ДОМА КЛИЕНТА:\n   - Клиент живет в городе: ${fromCity}\n   - ВЫЛЕТ САМОЛЕТА СТРОГО из аэропорта: ${majorCity.name} (${majorCity.code})\n   ${fromCity.toLowerCase()!==majorCity.name.toLowerCase()?`- Клиент должен добраться из ${fromCity} до ${majorCity.name} на автобусе/поезде`:''}\n   \n3. АЭРОПОРТ ПРИЛЕТА:\n   - Ты ОБЯЗАН найти ближайший КРУПНЫЙ аэропорт к месту назначения\n   - КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО прилетать в маленькие города, если есть крупный аэропорт рядом\n   - Примеры ПРАВИЛЬНО:\n     * Алтай → прилет в Барнаул (BAX)\n     * Камчатка → Петропавловск-Камчатский (PKC)\n     * Байкал → Иркутск (IKT)\n     \n4. ЕСЛИ НАПРАВЛЕНИЕ МОСКВА ИЛИ САНКТ-ПЕТЕРБУРГ:\n   - САМОЛЕТ НЕ ИСПОЛЬЗУЕТСЯ ВООБЩЕ!\n   - Используй ТОЛЬКО поезд или автобус\n   - В программе НЕ УКАЗЫВАЙ перелеты для этих городов\n   \n5. В ОТВЕТЕ ТЫ ОБЯЗАН УКАЗАТЬ:\n   - АЭРОПОРТ вылета: ${majorCity.name} (${majorCity.code})\n   - АЭРОПОРТ прилета с кодом (например: "Барнаул BAX")\n   ${fromCity.toLowerCase()!==majorCity.name.toLowerCase()?`- Как клиент доберется из ${fromCity} до ${majorCity.name}`:''}\n   - Если конечное место назначения не имеет аэропорта - указать трансфер из города прилета`;prompt+=`\n\nФОРМАТ ОТВЕТА (строго соблюдай этот формат!):\n1. Напиши краткое вступление (1-2 предложения) в дружелюбном тоне\n2. Затем обязательно напиши каждый вариант в таком формате:\n\nВариант 1: [Название города]\nПерелет: [Город вылета CODE] → [Город прилета CODE] (или "Маршрут: поезд/автобус" для Москвы/СПБ)\n[2-3 предложения почему этот вариант подходит]\n\nВариант 2: [Название города]\nПерелет: [Город вылета CODE] → [Город прилета CODE] (или "Маршрут: поезд/автобус" для Москвы/СПБ)\n[2-3 предложения почему этот вариант подходит]\n\nВариант 3: [Название города]\nПерелет: [Город вылета CODE] → [Город прилета CODE] (или "Маршрут: поезд/автобус" для Москвы/СПБ)\n[2-3 предложения почему этот вариант подходит]\n\n3. НЕ пиши подробную программу сейчас - она будет запросена отдельно при выборе варианта\n4. Обязательно используй слово "Вариант" и номер`;return prompt;}}
async function sendToGPT(message){state.isLoading=true;addLoadingMessage();try{const response=await fetch("https://functions.yandexcloud.net/d4e3fempk5bopa9943rp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message,history:[]})});const data=await response.json();state.isLoading=false;removeLoadingMessage();if(data.reply){let formattedReply = data.reply.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');addMessage(formattedReply,false);const proposals=parseProposalsFromGPT(data.reply);console.log('Найденные варианты:',proposals);if(proposals.length>0){state.currentProposals=proposals;renderQuickReplies();}else{console.warn('Не удалось распарсить варианты из ответа GPT');addMessage("К сожалению, не удалось обработать варианты. Попробуйте поискать другие варианты.",false);}}}catch(error){state.isLoading=false;removeLoadingMessage();console.error("Ошибка:",error);addMessage("Ошибка соединения с сервером",false);}}
function parseProposalsFromGPT(text){const proposals=[];console.log('Парсинг ответа GPT, длина текста:',text.length);console.log('Текст для парсинга:',text.substring(0,500));
// Расширенные паттерны для поиска вариантов
const patterns=[
/Вариант\s*(\d+)[:\-—]\s*([^\n<*]+)/gi,
/Вариант\s*(\d+)[:\-—]\s*([^<\n]+?)(?=\n|$)/gi,
/\d+\.\s*([^<\n]+?)(?=\nПерелет|\nМаршрут)/gi,
/-\s*([^<\n]+?)(?=\nПерелет|\nМаршрут)/gi
];
let foundMatches=false;
for(const pattern of patterns){
const matches=[...text.matchAll(pattern)];
console.log(`Паттерн ${pattern}: найдено совпадений:`,matches.length);
if(matches.length>=1){
foundMatches=true;
for(let i=0;i<Math.min(matches.length,3);i++){
let cityName=matches[i][2]||matches[i][1];
cityName=cityName.trim();
// Очистка названия от лишних символов
cityName=cityName.split(/[-—–\n<]/)[0].trim();
cityName=cityName.replace(/^\d+\.?\s*/,'').trim();
cityName=cityName.replace(/[.*]/g,'').trim();
console.log(`Вариант ${i+1}: город="${cityName}"`);
if(cityName&&cityName.length>1){
const cityData=findAirportCode(cityName);
if(cityData){
proposals.push({
destination:cityName,
country:cityData.country,
translitLower:cityData.translitLower,
code:cityData.code,
valid:true
});
console.log(`✅ Добавлен вариант из базы:`,proposals[proposals.length-1]);
}else{
const translitLower=transliterate(cityName).toLowerCase();
proposals.push({
destination:cityName,
country:"Разное",
translitLower:translitLower,
code:"XXX",
valid:true
});
console.log(`⚠️ Город не найден в базе, создан транслит: ${translitLower}`);
}
}
}
break;
}
}
// Если не нашли по паттернам, попробуем извлечь города другим способом
if(!foundMatches){
console.log('Не найдено совпадений по паттернам, пытаемся извлечь города другим способом');
// Ищем упоминания городов в тексте
const lines=text.split('\n').filter(line=>line.trim().length>10);
const potentialCities=lines.slice(0,6);
for(let i=0;i<Math.min(potentialCities.length,3);i++){
let line=potentialCities[i].trim();
line=line.replace(/<[^>]*>/g,'').trim();
line=line.replace(/[*\-—–•]/g,'').trim();
const words=line.split(/\s+/).slice(0,3);
let cityName=words.join(' ').replace(/[^\w\sа-яА-ЯёЁ\-]/g,'').trim();
if(cityName&&cityName.length>2){
console.log(`Потенциальный город из текста: "${cityName}"`);
const cityData=findAirportCode(cityName);
if(cityData||cityName.length>3){
proposals.push({
destination:cityName,
country:cityData?cityData.country:"Разное",
translitLower:cityData?cityData.translitLower:transliterate(cityName).toLowerCase(),
code:cityData?cityData.code:"XXX",
valid:true
});
}
}
}
}
// Убираем дубликаты
const uniqueProposals=proposals.filter((city,index,self)=>
index===self.findIndex(c=>c.destination===city.destination)
);
console.log('Итоговые уникальные предложения:',uniqueProposals);
// Если все еще нет вариантов, создаем заглушки
if(uniqueProposals.length===0){
console.log('Создаем заглушечные варианты');
for(let i=1;i<=3;i++){
proposals.push({
destination:`Направление ${i}`,
country:"Разное",
translitLower:`direction-${i}`,
code:"XXX",
valid:true
});
}
}
return uniqueProposals.length>0?uniqueProposals:proposals;
}
async function handleProposalSelect(proposalIndex){const proposal=state.currentProposals[proposalIndex];addMessage(`Вариант ${proposalIndex+1}: ${proposal.destination}`,true);state.selectedProposal=proposal;renderQuickReplies();const destination=proposal.destination;const days=state.isAlternativeScenario?(state.answers[5]?calculateDays(state.answers[5].from,state.answers[5].to):7):(state.answers[4]?calculateDays(state.answers[4].from,state.answers[4].to):7);state.excursionDays=Math.min(Math.ceil(days/3),5);const fromCity=state.isAlternativeScenario?state.answers[0]:state.answers[0];const transportRestrictions=state.isAlternativeScenario?"Нет":(state.answers[21]||"Нет");const canFly=transportRestrictions!=="Не летаю";const isDestinationMoscowOrSpb=destination.toLowerCase()==='москва'||destination.toLowerCase()==='санкт-петербург'||destination.toLowerCase()==='петербург';const majorCityForDetail=getNearestMajorCity(fromCity);const additionalPreferences=state.isAlternativeScenario?"":(state.answers[24]||"");const detailPrompt=`Подробно распиши программу в ${destination} на ${days} дней с учетом ВСЕХ предпочтений клиента.\n\n⚠️ КРИТИЧЕСКИ ВАЖНО - ЛОГИСТИКА И ТРАНСПОРТ:\n\n${isDestinationMoscowOrSpb?`\n1. НАПРАВЛЕНИЕ В МОСКВУ/СПБ - САМОЛЕТ НЕ ИСПОЛЬЗУЕТСЯ!\n   - Клиент живет в ${fromCity}\n   - Используй ТОЛЬКО поезд или автобус\n   - Первый день: выезд на поезде/автобусе из ${fromCity} в ${destination}\n   - Последний день: возвращение на поезде/автобусе из ${destination} в ${fromCity}\n   - НЕ УКАЗЫВАЙ аэропорты и перелеты`:`\n1. ОСНОВНОЕ ПЕРЕМЕЩЕНИЕ: ${canFly?'ТОЛЬКО НА САМОЛЕТЕ':'БЕЗ САМОЛЕТОВ (поезд/автобус)'}\n\n2. ЛОГИСТИКА ОТ ДОМА КЛИЕНТА:\n   - Клиент живет в городе: ${fromCity}\n   - ВЫЛЕТ САМОЛЕТА СТРОГО из аэропорта: ${majorCityForDetail.name} (${majorCityForDetail.code})\n   ${fromCity.toLowerCase()!==majorCityForDetail.name.toLowerCase()?`- День 1: Клиент едет из ${fromCity} до ${majorCityForDetail.name} на автобусе/поезде`:''}\n   - Определи ближайший КРУПНЫЙ аэропорт к ${destination} для ПРИЛЕТА\n   - КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО использовать маленькие аэропорты вместо крупных!\n\n3. РЕАЛЬНЫЙ маршрут с учетом географии:\n   - ВЫЛЕТ: ${majorCityForDetail.name} (${majorCityForDetail.code})\n   - ПРИЛЕТ: [определи крупный аэропорт для ${destination}]\n   - Все промежуточные пункты (автобусы, поезда, трансферы)`}\n\nДАННЫЕ КЛИЕНТА:\n- Город проживания: ${fromCity}\n- Аэропорт вылета: ${isDestinationMoscowOrSpb?'НЕТ (поезд/автобус)':`${majorCityForDetail.name} (${majorCityForDetail.code})`}\n- Пункт назначения: ${destination}\n- Продолжительность: ${days} дней\n${additionalPreferences?`- Дополнительные пожелания: ${additionalPreferences}`:''}\n\nТРЕБОВАНИЯ К ПРОГРАММЕ:\n- Учитывай ВСЕ предпочтения пользователя из анкеты\n- Создай СБАЛАНСИРОВАННЫЙ маршрут на ${days} дней\n- Называй КОНКРЕТНЫЕ МЕСТА для посещения\n- ОБЯЗАТЕЛЬНО учитывай логистику\n- Начни с детального описания как добраться из ${fromCity} до ${destination}\n${!isDestinationMoscowOrSpb?'- ОБЯЗАТЕЛЬНО укажи коды аэропортов (например: LED, MOW, BAX)':''}\n- НЕ ПИШИ никаких уточнений в скобках типа "аэропорт не уточняется"\n- ИСПОЛЬЗУЙ HTML теги для заголовков: <strong>Название заголовка:</strong> вместо **Название заголовка:**\n\n⚠️ <strong>ОБЯЗАТЕЛЬНО УКАЗЫВАЙ КОНКРЕТНЫЕ НАЗВАНИЯ:</strong>\n- Рестораны и кафе (например: "Ресторан 'У озера'", "Кафе 'Старый город'")\n- Сувенирные магазины (например: "Магазин 'Сувениры от ремесленников'", "Лавка 'Местные деликатесы'")\n- Достопримечательности (например: "Собор Святого Петра", "Национальный парк 'Озеро Байкал'")\n- Отели (например: "Отель 'Гранд Плаза'", "Гостиница 'Уютный уголок'")\n\nФОРМАТ ОТВЕТА (строго соблюдай):\n\n✈️ <strong>Маршрут путешествия:</strong>\n• День 1: [ДЕТАЛЬНЫЙ маршрут с транспортом и временем, КОНКРЕТНЫЕ названия]\n• День 2: [Активности с КОНКРЕТНЫМИ названиями мест]\n...\n• День ${days}: [Обратный маршрут]\n\n<strong>Что включено в программу:</strong>\n- Все переезды (детально)\n- Проживание в [КОНКРЕТНЫЙ отель]\n- Питание в [КОНКРЕТНЫЕ рестораны]\n- Экскурсии с [КОНКРЕТНЫЕ гиды/агентства]\n- Трансферы\n\n<strong>Примерный бюджет:</strong> X-X тысяч рублей на человека\n\n✨ <strong>Идеально для вас потому что:</strong> [персонализация]\n\n⚠️ <strong>Важные советы:</strong>\n- [Практические советы]\n\nСТИЛЬ: Дружелюбно, подробно. Используй эмодзи.`;state.isLoading=true;addLoadingMessage();try{const response=await fetch("https://functions.yandexcloud.net/d4e3fempk5bopa9943rp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:detailPrompt,history:[]})});const data=await response.json();state.isLoading=false;removeLoadingMessage();if(data.reply){let cleanedReply=data.reply;cleanedReply=cleanedReply.replace(/\s*\(аэропорт не уточняется[^)]*\)/gi,'');cleanedReply=cleanedReply.replace(/\s*\(но предполагается[^)]*\)/gi,'');cleanedReply=cleanedReply.replace(/\s*\(предполагается крупный аэропорт[^)]*\)/gi,'');cleanedReply=cleanedReply.replace(/```/g,'');cleanedReply = cleanedReply.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');addMessage(cleanedReply,false);state.tourProgram=cleanedReply;addMessage("Я сохранила программу, а также сформировала ссылки на билеты и необходимые брони в левом меню. Напиши мне свой электронный адрес в формате example@email.ru, чтобы я могла выслать наши наработки тебе!",false);const dateInfo=state.isAlternativeScenario?state.answers[5]:state.answers[4];const fromCity=state.isAlternativeScenario?state.answers[0]:state.answers[0];const budgetType=state.isAlternativeScenario?state.answers[6]:state.answers[5];const budgetPerPerson=state.isAlternativeScenario?state.answers[7]:state.answers[6];let wantsExcursions=true;if(dateInfo){const airportData=findAirportCode(destination);const iataCode=airportData?airportData.code:null;const arrivalCity=destination;console.log('Финальные данные для ссылок:',{destination,iataCode,arrivalCity});addPartnerLinks(proposal.destination,budgetType,budgetPerPerson,dateInfo.from,dateInfo.to,fromCity,wantsExcursions,iataCode,arrivalCity);saveChatToHistory(proposal.destination,dateInfo.from,dateInfo.to,state.partnerLinks);}
showEmailInput();}}catch(error){state.isLoading=false;removeLoadingMessage();console.error("Ошибка:",error);addMessage("Ошибка получения подробной программы",false);}}
function showEmailInput(){const container=document.createElement('div');container.className='email-input-container';container.id='emailInputContainer';container.innerHTML=`<div class="email-input-wrapper"><input type="email" class="email-input" id="emailInputField" placeholder="example@email.ru" /><button class="email-send-btn" id="emailSendBtn" onclick="handleEmailSubmit()">Отправить</button></div>`;messagesArea.appendChild(container);const emailInput=document.getElementById('emailInputField');emailInput.addEventListener('keypress',(e)=>{if(e.key==='Enter')handleEmailSubmit();});emailInput.focus();scrollToBottom();}
function handleEmailSubmit(){const emailInput=document.getElementById('emailInputField');const emailBtn=document.getElementById('emailSendBtn');const userEmail=emailInput?.value.trim();if(!userEmail){alert('⚠️ Введите email');return;}
const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!emailRegex.test(userEmail)){alert('⚠️ Введите корректный email адрес');return;}
const originalText=emailBtn.textContent;emailBtn.textContent='Отправляем...';emailBtn.disabled=true;let emailContent=`Программа:\n\n${formatTourProgramForEmail(state.tourProgram)}\n\n`;emailContent+=`Полезные ссылки для бронирования:\n\n`;state.partnerLinks.forEach(link=>{emailContent+=`${link.text}: ${link.url}\n`;});emailjs.send("service_ck0vlyb","template_gudupyl",{to_email:userEmail,email:userEmail,comment:emailContent,date:new Date().toLocaleString(),from_name:"Турвиго"}).then(function(response){addMessage(`Письмо успешно отправлено на ${userEmail}!`,false);}).catch(function(error){alert('❌ Ошибка отправки. Попробуйте еще раз.');console.error('EmailJS error:',error);}).finally(function(){emailBtn.textContent=originalText;emailBtn.disabled=false;});}
function formatTourProgramForEmail(program){if(!program)return program;let formattedProgram=program;formattedProgram=formattedProgram.replace(/• День (\d+):/g,'\n\nДень $1:\n');formattedProgram=formattedProgram.replace(/<strong>(.*?)<\/strong>/g,'$1');formattedProgram=formattedProgram.replace(/\*\*(.*?)\*\*/g,'$1');formattedProgram=formattedProgram.replace(/✈️/g,'');formattedProgram=formattedProgram.replace(/✨/g,'');formattedProgram=formattedProgram.replace(/⚠️/g,'Внимание:');return formattedProgram;}
function handleFindOther(){addMessage("Найти другие варианты",true);state.selectedProposal=null;state.currentProposals=[];const retryPrompt=generateGPTPrompt()+"\n\nПредложи другие 3 варианта, отличные от предыдущих.";sendToGPT(retryPrompt);}
init();
</script>
</body>
</html>
